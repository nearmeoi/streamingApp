---
import MainLayout from "../../../layouts/MainLayout.astro";
import MediaCard from "../../../components/media/MediaCard.astro";
import { getGenreDetail } from "../../../lib/api";

const { slug, page } = Astro.params;
const currentPage = parseInt(page || "1");
const genreData = await getGenreDetail(slug || "", currentPage);
const items = genreData?.data || [];

// Format genre name from slug
const genreName = (slug || "")
    .split("-")
    .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ");

// Pagination
const hasNext = items.length > 0;
const prevPage = currentPage > 1 ? currentPage - 1 : null;
const nextPage = hasNext ? currentPage + 1 : null;
---

<MainLayout title={`${genreName} - HuaStream`}>
    <div class="container mx-auto px-4 py-8">
        <div class="flex items-center gap-4 mb-8">
            <a
                href="/genres"
                class="p-2 rounded-full hover:bg-highlight transition-colors"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><path d="m15 18-6-6 6-6"></path></svg
                >
            </a>
            <div>
                <p class="text-xs text-secondary uppercase tracking-wider">
                    Genre
                </p>
                <h1 class="text-2xl font-bold">{genreName}</h1>
            </div>
        </div>

        {
            items.length > 0 ? (
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-8">
                    {items.map((item) => (
                        <a
                            href={`/detail/${item.slug}`}
                            class="group flex flex-col gap-2"
                        >
                            <div class="relative aspect-poster w-full overflow-hidden rounded-lg bg-highlight shadow-sm transition-transform duration-300 group-hover:scale-105">
                                <img
                                    src={item.poster}
                                    alt={item.title}
                                    class="h-full w-full object-cover"
                                    loading="lazy"
                                />
                                <div class="absolute top-2 left-2">
                                    <span class="px-1.5 py-0.5 bg-accent/80 text-[10px] font-bold text-white rounded">
                                        {item.status}
                                    </span>
                                </div>
                            </div>
                            <div class="flex flex-col gap-0.5">
                                <h3 class="truncate text-sm font-medium text-primary group-hover:text-accent transition-colors">
                                    {item.title}
                                </h3>
                                <span class="text-xs text-secondary">
                                    {item.type}
                                </span>
                            </div>
                        </a>
                    ))}
                </div>
            ) : (
                <div class="text-center py-20">
                    <h2 class="text-xl font-bold mb-2">No more items</h2>
                    <a
                        href={`/genres/${slug}/1`}
                        class="text-accent hover:underline"
                    >
                        Go back to start
                    </a>
                </div>
            )
        }

        <!-- Pagination -->
        <div class="flex justify-center items-center gap-4 mt-6 pb-4">
            {
                prevPage ? (
                    <a
                        href={`/genres/${slug}/${prevPage}`}
                        class="px-4 py-2 text-sm md:text-base bg-surface border border-highlight rounded-lg font-bold hover:bg-highlight transition-colors"
                    >
                        Previous
                    </a>
                ) : (
                    <button
                        disabled
                        class="px-4 py-2 text-sm md:text-base bg-base border border-highlight rounded-lg font-bold opacity-50 cursor-not-allowed"
                    >
                        Previous
                    </button>
                )
            }

            <span
                class="px-4 py-2 text-sm md:text-base font-medium text-secondary flex items-center"
            >
                Page {currentPage}
            </span>

            {
                nextPage && items.length > 0 ? (
                    <a
                        href={`/genres/${slug}/${nextPage}`}
                        class="px-4 py-2 text-sm md:text-base bg-accent text-white rounded-lg font-bold hover:bg-accent/80 transition-colors"
                    >
                        Next
                    </a>
                ) : (
                    <button
                        disabled
                        class="px-4 py-2 text-sm md:text-base bg-base border border-highlight rounded-lg font-bold opacity-50 cursor-not-allowed"
                    >
                        Next
                    </button>
                )
            }
        </div>
    </div>
</MainLayout>
