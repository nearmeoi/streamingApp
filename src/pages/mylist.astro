---
import MainLayout from "../layouts/MainLayout.astro";
---

<MainLayout title="My List - HuaStream">
    <div class="container mx-auto px-4 py-6">
        <div
            class="max-w-5xl mx-auto md:glass md:p-10 md:rounded-3xl flex flex-col"
        >
            <h1
                id="mylist-title"
                class="text-3xl font-bold mb-6 text-center md:text-left"
            >
                My List
            </h1>

            <div
                id="empty-state"
                class="hidden flex flex-col items-center justify-center text-center py-20"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="64"
                    height="64"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="mb-4 text-secondary"
                    ><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"
                    ></path></svg
                >
                <h2 class="text-xl font-bold mb-2">No favorites yet</h2>
                <p class="text-secondary mb-4">
                    Start adding donghua to your list!
                </p>
                <a
                    href="/genres"
                    class="inline-flex items-center gap-2 px-4 py-2 text-sm md:px-6 md:py-3 md:text-base bg-accent text-white font-bold rounded-lg hover:bg-accent/80 transition-colors"
                >
                    Browse Donghua
                </a>
            </div>

            <div
                id="mylist-grid"
                class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"
            >
                <!-- Items will be rendered by JS -->
            </div>
        </div>
    </div>
</MainLayout>

<script>
    const MYLIST_KEY = "huastream_mylist";
    const grid = document.getElementById("mylist-grid");
    const emptyState = document.getElementById("empty-state");
    const title = document.getElementById("mylist-title");

    function getMyList() {
        const data = localStorage.getItem(MYLIST_KEY);
        return data ? JSON.parse(data) : [];
    }

    function renderList() {
        const list = getMyList();

        if (list.length === 0) {
            emptyState?.classList.remove("hidden");
            grid?.classList.add("hidden");
            title?.classList.add("hidden");
            return;
        }

        emptyState?.classList.add("hidden");
        grid?.classList.remove("hidden");
        title?.classList.remove("hidden");

        // Sort by most recently added
        list.sort((a: any, b: any) => b.addedAt - a.addedAt);

        grid!.innerHTML = list
            .map(
                (item: any) => `
      <div class="group relative">
        <a href="/detail/${item.slug}" class="flex flex-col gap-2">
          <div class="relative aspect-poster w-full overflow-hidden rounded-lg bg-highlight shadow-sm transition-transform duration-300 group-hover:scale-105">
            <img src="${item.poster}" alt="${item.title}" class="h-full w-full object-cover" loading="lazy" />
          </div>
          <div class="flex flex-col gap-0.5">
            <h3 class="truncate text-sm font-medium text-primary group-hover:text-accent transition-colors">${item.title}</h3>
          </div>
        </a>
        <button 
          data-slug="${item.slug}" 
          class="remove-btn absolute top-2 right-2 p-2 bg-black/60 rounded-full text-white hover:bg-red-500 transition-colors opacity-0 group-hover:opacity-100"
          title="Remove from list"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
      </div>
    `,
            )
            .join("");

        // Add remove listeners
        document.querySelectorAll(".remove-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();
                const slug = (btn as HTMLElement).getAttribute("data-slug");
                if (slug) {
                    let list = getMyList();
                    list = list.filter((item: any) => item.slug !== slug);
                    localStorage.setItem(MYLIST_KEY, JSON.stringify(list));
                    renderList();
                }
            });
        });
    }

    // Init
    renderList();
</script>
