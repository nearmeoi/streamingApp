---
import MainLayout from "../layouts/MainLayout.astro";
---

<MainLayout title="HuaStream - Beranda">
  <!-- Hero Skeleton -->
  <div
    id="hero-skeleton"
    class="relative w-full aspect-[4/5] md:aspect-[21/9] overflow-hidden bg-surface"
  >
    <div class="absolute inset-0 skeleton"></div>
    <div
      class="absolute bottom-0 left-0 p-4 md:p-12 w-full md:w-2/3 flex flex-col gap-3"
    >
      <div class="skeleton w-20 h-6 rounded"></div>
      <div class="skeleton w-3/4 h-10 md:h-16 rounded"></div>
      <div class="skeleton w-full h-4 rounded mt-2"></div>
      <div class="skeleton w-2/3 h-4 rounded"></div>
      <div class="flex gap-3 mt-2">
        <div class="skeleton w-32 h-12 rounded-lg"></div>
        <div class="skeleton w-32 h-12 rounded-lg"></div>
      </div>
    </div>
  </div>

  <!-- Hero Content (hidden initially) -->
  <div id="hero-content" class="hidden"></div>

  <div class="md:relative md:z-10">
    <div
      class="container mx-auto px-4 py-8 flex flex-col gap-16 md:-mt-20 relative z-20"
    >
      <!-- Popular Updates Section -->
      <section class="md:glass md:p-8 md:rounded-3xl">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold border-l-4 border-accent pl-3">
            Pembaruan Populer
          </h2>
          <a
            href="/catalog/1"
            class="text-accent text-sm font-medium hover:underline flex items-center gap-1"
          >
            Lihat Semua
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"><path d="m9 18 6-6-6-6"></path></svg
            >
          </a>
        </div>

        <!-- Skeleton Grid -->
        <div
          id="popular-skeleton"
          class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"
        >
          {
            Array.from({ length: 10 }).map(() => (
              <div class="flex flex-col gap-2">
                <div class="aspect-poster w-full skeleton rounded-lg" />
                <div class="skeleton w-3/4 h-4 rounded" />
              </div>
            ))
          }
        </div>

        <!-- Real Content (hidden initially) -->
        <div
          id="popular-content"
          class="hidden grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"
        >
        </div>
      </section>

      <!-- Latest Release Section -->
      <section class="md:glass md:p-8 md:rounded-3xl">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold border-l-4 border-accent pl-3">
            Rilis Terbaru
          </h2>
          <a
            href="/catalog/1"
            class="text-accent text-sm font-medium hover:underline flex items-center gap-1"
          >
            Lihat Semua
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"><path d="m9 18 6-6-6-6"></path></svg
            >
          </a>
        </div>

        <!-- Skeleton Grid -->
        <div
          id="latest-skeleton"
          class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"
        >
          {
            Array.from({ length: 10 }).map(() => (
              <div class="flex flex-col gap-2">
                <div class="aspect-poster w-full skeleton rounded-lg" />
                <div class="skeleton w-3/4 h-4 rounded" />
              </div>
            ))
          }
        </div>

        <!-- Real Content (hidden initially) -->
        <div
          id="latest-content"
          class="hidden grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"
        >
        </div>
      </section>
    </div>
  </div>
</MainLayout>

<script>
  // Client-side data fetching for zero loading
  async function loadHomeData() {
    if (window.location.pathname !== "/") return;
    try {
      const response = await fetch("/api/home");
      if (!response.ok) throw new Error("API error");

      const data = await response.json();
      const items = data.latest_release || [];

      // Render hero
      renderHero(items.slice(0, 1)[0]);

      // Render popular (first 10)
      renderMediaGrid("popular", items.slice(0, 10));

      // Render latest (all)
      renderMediaGrid("latest", items);
    } catch (error) {
      console.error("[Home] Failed to load data:", error);
    }
  }

  function renderHero(item: any) {
    if (!item) return;

    const heroSkeleton = document.getElementById("hero-skeleton");
    const heroContent = document.getElementById("hero-content");

    if (!heroContent) return;

    const slug = item.slug.endsWith("/") ? item.slug.slice(0, -1) : item.slug;

    heroContent.innerHTML = `
      <div class="relative w-full aspect-[4/5] md:aspect-[21/9] overflow-hidden">
        <img src="${item.poster}" alt="${item.title}" class="w-full h-full object-cover" loading="eager" />
        <div class="absolute inset-0 bg-gradient-to-t from-base via-base/50 to-transparent"></div>
        <div class="absolute inset-0 bg-gradient-to-r from-base via-transparent to-transparent opacity-80"></div>
        <div class="absolute bottom-0 left-0 p-4 md:p-12 w-full md:w-2/3 flex flex-col gap-3 items-start">
          <span class="px-2 py-1 bg-accent text-[10px] font-bold rounded uppercase tracking-wider text-white">Sedang Tren</span>
          <h1 class="text-2xl md:text-6xl font-bold leading-tight line-clamp-2">${item.title}</h1>
          <p class="text-secondary text-sm md:text-base line-clamp-2 md:line-clamp-3 max-w-xl">
            Tonton ${item.current_episode || "episode terbaru"} dari ${item.title} sekarang di HuaStream.
          </p>
          <div class="flex gap-3 mt-2">
            <a href="/watch/${slug}" class="inline-flex items-center justify-center rounded-lg font-medium bg-accent text-white hover:bg-red-700 px-4 py-2 text-sm md:px-8 md:py-4 md:text-lg transition-colors">Tonton Sekarang</a>
            <button class="inline-flex items-center justify-center rounded-lg font-medium bg-highlight text-primary hover:bg-gray-700 px-4 py-2 text-sm md:px-8 md:py-4 md:text-lg transition-colors">+ Daftar Saya</button>
          </div>
        </div>
      </div>
    `;

    heroSkeleton?.classList.add("hidden");
    heroContent.classList.remove("hidden");
  }

  function renderMediaGrid(section: string, items: any[]) {
    const skeleton = document.getElementById(`${section}-skeleton`);
    const content = document.getElementById(`${section}-content`);

    if (!content) return;

    content.innerHTML = items
      .map((item) => {
        const slug = item.slug.endsWith("/")
          ? item.slug.slice(0, -1)
          : item.slug;
        return `
        <a href="/watch/${slug}" class="group relative flex flex-col gap-2 w-full outline-none">
          <div class="relative aspect-poster w-full overflow-hidden rounded-lg bg-highlight shadow-sm transition-transform duration-300 group-hover:scale-105">
            <div class="absolute inset-0 skeleton"></div>
            <img 
              src="${item.poster}" 
              alt="${item.title}" 
              class="relative h-full w-full object-cover opacity-0 transition-opacity duration-300"
              loading="lazy"
              decoding="async"
              onload="this.classList.remove('opacity-0'); this.classList.add('opacity-90');"
            />
            ${
              item.current_episode
                ? `
              <div class="absolute top-2 left-2">
                <span class="px-1.5 py-0.5 bg-black/60 backdrop-blur-md text-[10px] font-bold text-white rounded">${item.current_episode}</span>
              </div>
            `
                : ""
            }
          </div>
          <h3 class="truncate text-sm font-medium text-primary group-hover:text-accent transition-colors">${item.title}</h3>
        </a>
      `;
      })
      .join("");

    skeleton?.classList.add("hidden");
    content.classList.remove("hidden");
  }

  // Load data on page load and View Transitions
  loadHomeData();
  document.addEventListener("astro:page-load", loadHomeData);
</script>
