---
import MainLayout from "../../layouts/MainLayout.astro";
import MediaCard from "../../components/media/MediaCard.astro";
import { getHomeData } from "../../lib/api";

const { page } = Astro.params;
const currentPage = parseInt(page || "1");
const apiData = await getHomeData(currentPage);
const latestRelease = apiData?.latest_release || [];

const items = latestRelease.map((item) => ({
    title: item.title,
    slug: item.slug,
    poster: item.poster,
    episode: item.current_episode || item.episode || "New",
}));

// Pagination Logic
const hasNext = items.length > 0;
const prevPage = currentPage > 1 ? currentPage - 1 : null;
const nextPage = hasNext ? currentPage + 1 : null;
---

<MainLayout title={`Catalog Page ${currentPage} - HuaStream`}>
    <div class="container mx-auto px-4 py-8">
        <div class="flex items-center gap-4 mb-8">
            <a
                href="/"
                class="p-2 rounded-full hover:bg-highlight transition-colors"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><path d="m15 18-6-6 6-6"></path></svg
                >
            </a>
            <h1 class="text-2xl font-bold">Latest Releases</h1>
        </div>

        {
            items.length > 0 ? (
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-8">
                    {items.map((media) => (
                        <MediaCard media={media} episode={media.episode} />
                    ))}
                </div>
            ) : (
                <div class="text-center py-20">
                    <h2 class="text-xl font-bold mb-2">No more items</h2>
                    <a href="/catalog/1" class="text-accent hover:underline">
                        Go back to start
                    </a>
                </div>
            )
        }

        <!-- Pagination Controls -->
        <div class="flex justify-center items-center gap-4 mt-6 pb-4">
            {
                prevPage ? (
                    <a
                        href={`/catalog/${prevPage}`}
                        class="px-4 py-2 text-sm md:text-base bg-surface border border-highlight rounded-lg font-bold hover:bg-highlight transition-colors"
                    >
                        Previous
                    </a>
                ) : (
                    <button
                        disabled
                        class="px-4 py-2 text-sm md:text-base bg-base border border-highlight rounded-lg font-bold opacity-50 cursor-not-allowed"
                    >
                        Previous
                    </button>
                )
            }

            <span
                class="px-4 py-2 text-sm md:text-base font-medium text-secondary flex items-center"
            >
                Page {currentPage}
            </span>

            {
                nextPage && items.length > 0 ? (
                    <a
                        href={`/catalog/${nextPage}`}
                        class="px-4 py-2 text-sm md:text-base bg-accent text-white rounded-lg font-bold hover:bg-accent/80 transition-colors"
                    >
                        Next
                    </a>
                ) : (
                    <button
                        disabled
                        class="px-4 py-2 text-sm md:text-base bg-base border border-highlight rounded-lg font-bold opacity-50 cursor-not-allowed"
                    >
                        Next
                    </button>
                )
            }
        </div>
    </div>
</MainLayout>
