---
import MainLayout from "../../layouts/MainLayout.astro";

const { id } = Astro.params;

if (!id) {
    return Astro.redirect("/404");
}

const fallbackStream = "https://files.vidstack.io/agent-327/hls/stream.m3u8";
---

<MainLayout title="Memuat... - HuaStream">
    <div class="container mx-auto px-0 md:px-4 pt-0 md:pt-4 pb-4 relative">
        <!-- Back Button -->
        <a
            href="/"
            class="absolute top-4 left-4 z-40 p-2 bg-black/50 backdrop-blur-md rounded-full text-white hover:bg-accent transition-colors md:hidden"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"><path d="m15 18-6-6 6-6"></path></svg
            >
        </a>

        <!-- Player Container -->
        <div class="w-full max-w-5xl mx-auto">
            <!-- Video Player Skeleton -->
            <div
                id="player-skeleton"
                class="relative w-full aspect-video bg-surface skeleton rounded-lg overflow-hidden"
            >
                <div class="absolute inset-0 flex items-center justify-center">
                    <div
                        class="w-16 h-16 rounded-full bg-highlight/50 flex items-center justify-center"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="32"
                            height="32"
                            viewBox="0 0 24 24"
                            fill="white"
                            class="opacity-50"
                            ><polygon points="5 3 19 12 5 21 5 3"
                            ></polygon></svg
                        >
                    </div>
                </div>
            </div>

            <!-- Video Player (hidden initially) -->
            <div id="video-container" class="hidden" data-dynamic-content></div>

            <div class="p-4 flex flex-col gap-4">
                <!-- Title Skeleton -->
                <div id="title-skeleton" class="flex flex-col gap-2">
                    <div class="skeleton w-3/4 h-8 rounded"></div>
                    <div class="skeleton w-1/4 h-6 rounded"></div>
                </div>

                <!-- Title (hidden initially) -->
                <h1
                    id="title-content"
                    class="hidden text-xl md:text-2xl font-bold capitalize"
                    data-dynamic-content
                >
                </h1>

                <!-- Info Row Skeleton -->
                <div id="info-skeleton" class="flex flex-wrap gap-2">
                    <div class="skeleton w-20 h-6 rounded"></div>
                    <div class="skeleton w-24 h-6 rounded"></div>
                    <div class="skeleton w-28 h-6 rounded"></div>
                </div>

                <!-- Info Row (hidden initially) -->
                <div
                    id="info-content"
                    class="hidden flex flex-wrap gap-2 text-xs text-secondary"
                    data-dynamic-content
                >
                </div>

                <!-- Genres Skeleton -->
                <div id="genres-skeleton" class="flex flex-wrap gap-2">
                    {
                        Array.from({ length: 4 }).map(() => (
                            <div class="skeleton w-16 h-7 rounded-full" />
                        ))
                    }
                </div>

                <!-- Genres (hidden initially) -->
                <div
                    id="genres-content"
                    class="hidden flex flex-wrap gap-2"
                    data-dynamic-content
                >
                </div>

                <!-- Synopsis Skeleton -->
                <div id="synopsis-skeleton" class="mt-2 flex flex-col gap-2">
                    <div class="skeleton w-20 h-4 rounded"></div>
                    <div class="skeleton w-full h-4 rounded"></div>
                    <div class="skeleton w-3/4 h-4 rounded"></div>
                </div>

                <!-- Synopsis (hidden initially) -->
                <div
                    id="synopsis-content"
                    class="hidden mt-2"
                    data-dynamic-content
                >
                </div>

                <!-- Episode Grid Skeleton -->
                <div
                    id="episodes-skeleton"
                    class="mt-4 p-4 bg-surface/50 rounded-xl border border-highlight"
                >
                    <div class="skeleton w-24 h-6 rounded mb-4"></div>
                    <div
                        class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 gap-2"
                    >
                        {
                            Array.from({ length: 20 }).map(() => (
                                <div class="aspect-square skeleton rounded-lg" />
                            ))
                        }
                    </div>
                </div>

                <!-- Episode Grid (hidden initially) -->
                <div
                    id="episodes-content"
                    class="hidden mt-4 p-4 bg-surface/50 rounded-xl border border-highlight"
                    data-dynamic-content
                >
                </div>
            </div>
        </div>
    </div>
</MainLayout>

<script>
    const fallbackStream =
        "https://files.vidstack.io/agent-327/hls/stream.m3u8";

    // Get episode ID from URL dynamically (not cached like define:vars)
    function getEpisodeIdFromUrl() {
        const path = window.location.pathname;
        const match = path.match(/\/watch\/(.+?)(?:\/|$)/);
        return match ? match[1] : null;
    }

    // Reset to skeleton state immediately on page load
    function resetToSkeleton() {
        // Hide all content elements
        const contentIds = [
            "video-container",
            "title-content",
            "info-content",
            "genres-content",
            "synopsis-content",
            "episodes-content",
        ];
        contentIds.forEach((id) => {
            const el = document.getElementById(id);
            if (el) {
                el.classList.add("hidden");
                el.innerHTML = "";
            }
        });

        // Show all skeleton elements
        const skeletonIds = [
            "player-skeleton",
            "title-skeleton",
            "info-skeleton",
            "genres-skeleton",
            "synopsis-skeleton",
            "episodes-skeleton",
        ];
        skeletonIds.forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.classList.remove("hidden");
        });
    }

    // Run reset immediately (only if on watch page)
    if (window.location.pathname.startsWith("/watch/")) {
        resetToSkeleton();
    }

    async function loadEpisode() {
        // Only run on watch pages
        if (!window.location.pathname.startsWith("/watch/")) {
            return;
        }

        // Reset first in case of View Transition
        resetToSkeleton();

        // Get current episode ID from URL
        const episodeId = getEpisodeIdFromUrl();
        if (!episodeId) {
            return; // Just return, don't redirect
        }

        try {
            const response = await fetch(
                `/api/episode?slug=${encodeURIComponent(episodeId)}`,
            );
            if (!response.ok) {
                window.location.href = "/404";
                return;
            }

            const { episode: videoData, detail: detailData } =
                await response.json();

            if (!videoData) {
                window.location.href = "/404";
                return;
            }

            // Extract data
            const seriesTitle =
                detailData?.title ||
                videoData.donghua_details?.title ||
                videoData.episode;
            const poster =
                detailData?.poster || videoData.donghua_details?.poster || "";
            const synopsis = detailData?.synopsis || "";
            const genres = detailData?.genres || [];
            const studio = detailData?.studio || "";
            const status = detailData?.status || "";
            const episodesCount = detailData?.episodes_count || "";

            // Sort episodes ascending
            const detailEpisodes = (videoData.episodes_list || [])
                .slice()
                .sort((a, b) => {
                    const numA = parseInt(
                        a.episode.match(/Episode\s+(\d+)/i)?.[1] || "999",
                    );
                    const numB = parseInt(
                        b.episode.match(/Episode\s+(\d+)/i)?.[1] || "999",
                    );
                    return numA - numB;
                });

            // Current episode number
            const currentEpNumber = parseInt(
                videoData.episode.match(/Episode\s+(\d+)/i)?.[1] || "0",
            );

            // Stream URL
            let streamUrl = "";
            if (videoData.streaming) {
                streamUrl =
                    videoData.streaming.main_url?.url ||
                    videoData.streaming.servers?.[0]?.url ||
                    "";
            }

            // Update page title
            document.title = `${videoData.episode} - HuaStream`;

            // Render all sections
            renderVideoPlayer(streamUrl || fallbackStream, poster);
            renderTitle(seriesTitle, currentEpNumber);
            renderInfo(status, episodesCount, studio);
            renderGenres(genres);
            renderSynopsis(synopsis);
            renderEpisodes(detailEpisodes, currentEpNumber);
        } catch (error) {
            console.error("[Watch] Failed to load:", error);
        }
    }

    function renderVideoPlayer(src, poster) {
        const skeleton = document.getElementById("player-skeleton");
        const container = document.getElementById("video-container");

        if (!container) return;

        // Check if it's an iframe source or HLS
        const isIframe =
            src.includes("embed") ||
            src.includes("player") ||
            (!src.includes(".m3u8") && !src.includes(".mp4"));

        if (isIframe) {
            container.innerHTML = `
        <div class="relative w-full aspect-video bg-black rounded-lg overflow-hidden">
          <iframe 
            src="${src}" 
            class="absolute inset-0 w-full h-full" 
            allowfullscreen 
            allow="autoplay; fullscreen; picture-in-picture"
            frameborder="0"
          ></iframe>
        </div>
      `;
        } else {
            container.innerHTML = `
        <div class="relative w-full aspect-video bg-black rounded-lg overflow-hidden">
          <video 
            id="video-player"
            class="w-full h-full"
            controls
            crossorigin="anonymous"
            playsinline
            poster="${poster}"
          >
            <source src="${src}" type="application/x-mpegURL" />
          </video>
        </div>
      `;

            // Initialize HLS if needed
            if (src.includes(".m3u8")) {
                initHLS(src);
            }
        }

        skeleton?.classList.add("hidden");
        container.classList.remove("hidden");
    }

    async function initHLS(src) {
        const video = document.getElementById("video-player");
        if (!video) return;

        // Dynamically import HLS.js (should already be loaded)
        if (typeof Hls !== "undefined" && Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(src);
            hls.attachMedia(video);
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
            video.src = src;
        }
    }

    function renderTitle(seriesTitle, currentEpNumber) {
        const skeleton = document.getElementById("title-skeleton");
        const content = document.getElementById("title-content");

        if (!content) return;

        content.innerHTML = `${seriesTitle} <span class="text-accent">Episode ${currentEpNumber}</span>`;

        skeleton?.classList.add("hidden");
        content.classList.remove("hidden");
    }

    function renderInfo(status, episodesCount, studio) {
        const skeleton = document.getElementById("info-skeleton");
        const content = document.getElementById("info-content");

        if (!content) return;

        let html = "";
        if (status)
            html += `<span class="px-2 py-1 bg-accent/20 text-accent rounded">${status}</span>`;
        if (episodesCount)
            html += `<span class="px-2 py-1 bg-highlight rounded">${episodesCount}</span>`;
        if (studio)
            html += `<span class="px-2 py-1 bg-highlight rounded">Studio: ${studio}</span>`;

        content.innerHTML = html;

        skeleton?.classList.add("hidden");
        if (html) content.classList.remove("hidden");
    }

    function renderGenres(genres) {
        const skeleton = document.getElementById("genres-skeleton");
        const content = document.getElementById("genres-content");

        if (!content) return;

        if (genres.length > 0) {
            content.innerHTML = genres
                .map(
                    (genre) => `
        <span class="px-3 py-1 text-xs bg-surface border border-highlight rounded-full text-secondary hover:text-primary hover:border-accent transition-colors">${genre.name}</span>
      `,
                )
                .join("");
            content.classList.remove("hidden");
        }

        skeleton?.classList.add("hidden");
    }

    function renderSynopsis(synopsis) {
        const skeleton = document.getElementById("synopsis-skeleton");
        const content = document.getElementById("synopsis-content");

        if (!content) return;

        if (synopsis) {
            content.innerHTML = `
        <h3 class="font-bold text-sm mb-2 text-secondary">Sinopsis</h3>
        <div id="synopsis-container">
          <p id="synopsis-text" class="text-sm text-secondary leading-relaxed line-clamp-2">${synopsis}</p>
          <button id="synopsis-toggle" class="text-accent text-xs mt-1 hover:underline">Lihat selengkapnya...</button>
        </div>
      `;

            // Add toggle listener
            setTimeout(() => {
                const toggle = document.getElementById("synopsis-toggle");
                const text = document.getElementById("synopsis-text");
                let expanded = false;

                toggle?.addEventListener("click", () => {
                    expanded = !expanded;
                    if (expanded) {
                        text?.classList.remove("line-clamp-2");
                        toggle.textContent = "Lihat lebih sedikit";
                    } else {
                        text?.classList.add("line-clamp-2");
                        toggle.textContent = "Lihat selengkapnya...";
                    }
                });
            }, 100);

            content.classList.remove("hidden");
        }

        skeleton?.classList.add("hidden");
    }

    function renderEpisodes(episodes, currentEpNumber) {
        const skeleton = document.getElementById("episodes-skeleton");
        const content = document.getElementById("episodes-content");

        if (!content) return;

        content.innerHTML = `
      <h3 class="font-bold text-lg mb-4">Daftar Episode</h3>
      <div class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 gap-2 overflow-y-auto no-scrollbar" style="max-height: 300px;">
        ${episodes
            .map((ep) => {
                const epNum = parseInt(
                    ep.episode.match(/Episode\s+(\d+)/i)?.[1] || "0",
                );
                const isActive = epNum === currentEpNumber;
                return `
            <a href="/watch/${ep.slug}" class="aspect-square flex items-center justify-center rounded-lg border transition-colors font-medium text-sm ${isActive ? "bg-accent border-accent text-white" : "bg-surface border-highlight text-secondary hover:bg-highlight hover:text-primary"}">
              ${epNum}
            </a>
          `;
            })
            .join("")}
      </div>
    `;

        skeleton?.classList.add("hidden");
        content.classList.remove("hidden");
    }

    loadEpisode();
    document.addEventListener("astro:page-load", loadEpisode);
</script>

<!-- Include HLS.js for video playback -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
