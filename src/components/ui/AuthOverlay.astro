---
import Button from "../ui/Button.astro";
---

<div
    id="auth-overlay"
    class="hidden fixed inset-0 z-[90] flex items-center justify-center bg-base/95 backdrop-blur-xl"
>
    <div class="w-full max-w-md p-8 glass rounded-2xl mx-4 text-center">
        <div class="mb-8">
            <img
                src="/logo_typhography.png"
                alt="HuaStream"
                class="h-12 w-auto mx-auto mb-4"
            />
            <h2 class="text-2xl font-bold mb-2">Welcome to HuaStream</h2>
            <p class="text-secondary">Setup your profile to start watching.</p>
        </div>

        <form id="setup-form" class="space-y-6">
            <div>
                <label
                    class="block text-sm font-medium text-secondary mb-2 text-left"
                    >Your Name</label
                >
                <input
                    type="text"
                    id="username"
                    required
                    placeholder="Enter your name"
                    class="w-full bg-surface border border-white/10 rounded-lg px-4 py-3 text-white focus:border-accent focus:outline-none transition-colors"
                />
            </div>

            <div>
                <label
                    class="block text-sm font-medium text-secondary mb-3 text-left"
                    >Choose Avatar</label
                >
                <div class="grid grid-cols-4 gap-4" id="avatar-grid">
                    <!-- Avatars generated by JS -->
                </div>
                <input type="hidden" id="selected-avatar" required />
            </div>

            <Button type="submit" variant="primary" class="w-full py-3 text-lg">
                Start Watching
            </Button>
        </form>
    </div>
</div>

<script>
    const authOverlay = document.getElementById("auth-overlay");
    const form = document.getElementById("setup-form");
    const avatarGrid = document.getElementById("avatar-grid");
    const avatarInput = document.getElementById(
        "selected-avatar",
    ) as HTMLInputElement;

    const AVATARS = [
        "https://api.dicebear.com/7.x/adventurer/svg?seed=Felix",
        "https://api.dicebear.com/7.x/adventurer/svg?seed=Aneka",
        "https://api.dicebear.com/7.x/adventurer/svg?seed=Zoe",
        "https://api.dicebear.com/7.x/adventurer/svg?seed=Jack",
    ];

    // Render avatars
    if (avatarGrid) {
        avatarGrid.innerHTML = AVATARS.map(
            (url, i) => `
      <div 
        class="avatar-option aspect-square rounded-full border-2 border-transparent hover:border-accent/50 cursor-pointer overflow-hidden transition-all bg-surface"
        data-url="${url}"
      >
        <img src="${url}" class="w-full h-full object-cover" />
      </div>
    `,
        ).join("");
    }

    // Handle avatar selection
    avatarGrid?.querySelectorAll(".avatar-option").forEach((opt) => {
        opt.addEventListener("click", () => {
            // Reset others
            avatarGrid.querySelectorAll(".avatar-option").forEach((el) => {
                el.classList.remove("border-accent", "scale-110");
                el.classList.add("border-transparent");
            });
            // Select this
            opt.classList.remove("border-transparent");
            opt.classList.add("border-accent", "scale-110");
            avatarInput.value = opt.getAttribute("data-url") || "";
        });
    });

    // Select first by default
    const firstAvatar = avatarGrid?.querySelector(".avatar-option");
    if (firstAvatar) (firstAvatar as HTMLElement).click();

    // Check Auth
    const user = localStorage.getItem("huastream_user");

    // Show only if not logged in and splash is done (or immediately if no splash logic)
    if (!user) {
        // Small delay to let splash finish if it's there
        setTimeout(() => {
            authOverlay?.classList.remove("hidden");
        }, 100);
    }

    // Handle Submit
    form?.addEventListener("submit", (e) => {
        e.preventDefault();
        const name = (document.getElementById("username") as HTMLInputElement)
            .value;
        const avatar = avatarInput.value;

        if (name && avatar) {
            const newUser = {
                name,
                avatar,
                joinedAt: Date.now(),
            };
            localStorage.setItem("huastream_user", JSON.stringify(newUser));

            // Fade out
            authOverlay?.classList.add(
                "opacity-0",
                "transition-opacity",
                "duration-500",
            );
            setTimeout(() => {
                authOverlay?.classList.add("hidden");
                window.location.reload(); // Reload to update UI
            }, 500);
        }
    });
</script>
